---
layout:     post
title:      .git 目录过大问题解决方案
date:       2020-03-18
author:     jiulongzhu
header-img: img/moon_night.jpg
catalog: true
tags:
    - tools
---

.git 目录会记录所有文件的历史操作，当提交次数很多 特别是包含大文件时，很容易导致.git 目录很大，尤其是.git/objects/pack。造成的影响有流量超限、自动化部署慢等。   

<!-- more -->

>
repo 最好配置 gitignore 文件。   
git push 使用--force 或 -f 选项时，应通知 repo 的所有用户。   
repo 中使用正则表达式删除时一定要慎重。    

### clone时目录大  
使用--depth 指定 clone 深度，仅 clone 默认分支的最近一次 commit。如果需要 clone 其他分支，可以通过设置分支来拉取其他分支。  

```
$ git clone --depth=1 https://github.com/xxx/yyy.git
$ git remote set-branches origin $remote_branch 
$ git fetch --depth=1 origin $remote_branch 
$ git checkout $remote_branch 
```

### 不重要 repo 可重建  
对于个人文件存储、传输用途等不重要的 repo，可以重建版本库。      

```
$ rm -rf  .git 
$ git init
$ git remote add origin $repo_url 
$ git checkout -b $branch
$ git add * 
$ git commit -m "reBuild" 
$ git push --set-upstream origin $branch --force
```

### rebase
有选择性合并历史提交，人工成本较高。    

```
$ git logs 
$ git rebase -i $commitId 
pick 93a7f37 upd
pick c70583b upd
pick 11cb78f upd
pick f11f716 upd
pick d1ee55c upd

将待合并的 commit id 前的 pick 字符串改成 s
pick 93a7f37 upd
pick c70583b upd
pick 11cb78f upd
s f11f716 upd
pick d1ee55c upd

这样第四个commit 会合并到第三个提交上。  
$ git push --force 
$ git gc -prune=now		清理本地版本库
```

### 删除特定大文件的历史记录      

##### 查询 .git 目录中最大的 10 个文件  

```
git rev-list --objects --all | grep -f <(git verify-pack -v .git/objects/pack/*.idx| sort -k 3 -n | cut -f 1 -d " " | tail -10) 
```

输出范例如下:  

```
...
0afba5819d9df014734e70de6a3f237f4f56e33f spark-3.0.0-SNAPSHOT-bin-custom-spark.tgz
996132b957dc1604cb97cc0c6caaf4f17dfea90f jlz/spark-tpc-ds-performance-test-master/src/data/catalog\_sales/catalog\_sales\_part1.dat 
5af74da26b3dac5ed53f0e7f31b4b95b31730315 jlz/spark-tpc-ds-performance-test-master/src/data/catalog\_sales/catalog\_sales\_part2.dat
...
```

##### 在版本库中删除特定文件

```  
git filter-branch --index-filter 'git rm --cached --ignore-unmatch spark-3.0.0-SNAPSHOT-bin-custom-spark.tgz catalog\_sales\_part*.dat' -- --all  
rm -rf .git/refs/original   
rm -rf .git/logs/  
git gc --aggressive --prune=now   
```

##### 提交到远程仓库 

```
git push --force  
```


